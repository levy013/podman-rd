<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>cad-containters</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">cad-containters</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="config"><a class="header" href="#config">Config</a></h1>
<h2 id="configure-the-firewalld-service-to-accept-http-requests"><a class="header" href="#configure-the-firewalld-service-to-accept-http-requests">Configure the <code>firewalld</code> service to accept http requests</a></h2>
<p><a href="https://www.redhat.com/en/blog/firewalld-linux-firewall">RHEL firewalld Docs</a></p>
<p>By default, <code>firewalld</code> does not allow http requests</p>
<p><code>sudo firewall-cmd --add-service=http --permanent</code></p>
<p><code>sudo firewall-cmd --reload</code></p>
<h2 id="selinux"><a class="header" href="#selinux">SELinux</a></h2>
<p><a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/8/html/using_selinux/index">RHEL SELinux Docs</a></p>
<p>When SELinux Enforcing mode is enabled, the policy for <code>httpd_t</code> (which Nginx runs under) restricts outbound network connections by default.</p>
<p>This means that Nginx is not allowed to make outbound requests, e.g. using <code>proxy_pass</code>:</p>
<p><code>connect() to 127.0.0.1:8080 failed (13: Permission denied)</code></p>
<p>Instead of setting SELinux to permissive mode, we can simply allow Nginx to make outbound connections:</p>
<p><code>sudo setsebool -P httpd_can_network_connect on</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nginx"><a class="header" href="#nginx">Nginx</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nginx-1"><a class="header" href="#nginx-1">Nginx</a></h1>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p><code>sudo dnf install nginx</code></p>
<p><code>sudo systemctl enable --now nginx</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nginx-2"><a class="header" href="#nginx-2">Nginx</a></h1>
<h2 id="reverse-proxy"><a class="header" href="#reverse-proxy">Reverse Proxy</a></h2>
<p><em><a href="https://github.com/levy013/podman-research?tab=readme-ov-file#step-4-start-app-in-container">Starting an App in a Container</a></em></p>
<p><em><a href="nginx/">Installing Nginx</a></em></p>
<h2 id="what-is-a-reverse-proxy"><a class="header" href="#what-is-a-reverse-proxy">What is a reverse proxy?</a></h2>
<p><em>A reverse proxy acts as an intermediary between clients and servers. They intercept client requests and forward them to the appropriate backend service.</em>
https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/</p>
<h2 id="use-case"><a class="header" href="#use-case">Use Case:</a></h2>
<p>By default, our applications are accessible from the server's hostname on the ports that we choose to expose when running the containers.
e.g. we expose port 8080 on uit1446 to serve CAD.MQ.API =&gt; http://uit1446:8080/api/list</p>
<p>But this is admittedly pretty obnoxious for the client to use effectively.</p>
<p>Assuming we've set up some DNS entries on the local network (or modified our Hosts file), we can use Nginx to bind our apps to those addresses on the server and serve our content from an "alias".</p>
<p>A reverse proxy will allow us to specify both a hostname and it's related path(s) for the client to reach out to. This maintains a consistent "shape" for the request to take on that Nginx can subsequently match against and proxy to the corresponding resource on the server.</p>
<p>Here is an example using CAD.MQ.API</p>
<ul>
<li>Our application is running on the server exposed on http://localhost:8080/</li>
<li>Clients can natively make requests to the service on http://uit1446:8080/</li>
<li>With a reverse proxy we can offer the client a prettier URI, such as http://cadlnx/mq/</li>
</ul>
<h2 id="setup"><a class="header" href="#setup">Setup:</a></h2>
<ol>
<li>Set up custom conf inside of <code>/etc/nginx/conf.d/</code></li>
</ol>
<blockquote>
<p>Instead of modifying <code>/etc/nginx/nginx.conf</code> directly, it's generally considered best practice to create a custom conf inside of <code>/conf.d</code></p>
<p>In this example, we're writing to <code>/etc/nginx/conf.d/cad.conf</code></p>
</blockquote>
<ol start="2">
<li>Add the reverse proxy config</li>
</ol>
<pre><code class="language-nginx">server { 
        listen 80; # what port Nginx should listen on
        server_name cadlnx; # what hostname the following location block(s) should respond to
         
        location /mq/ { # location block containing rules/logic for handling requests to http://cadlnx/mq/*
                rewrite ^/mq/(.*)$ /$1 break; 
                proxy_pass http://127.0.0.1:8080; # underlying address we're proxying traffic to 

                proxy_set_header Host $host; # retains original host value e.g. cadlnx
                proxy_set_header X-Real-IP $remote_addr; # client's real IP addr 
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # full chain of fwd IPs
                proxy_set_header X-Forwarded-Proto $scheme; # http or https 
        }

        location /foo/ { # e.g. some other location block for handling http://cadlnx/foo/
                ...
        }
} 
</code></pre>
<p>Understanding <code>rewrite ^/mq/(.*)$ /$1 break;</code></p>
<blockquote>
<p><em>It's important to remember that we're simply proxying traffic here. The idea behind this rewrite is that we need to strip /mq/ from the URI and reappend any parameters from the capture group.</em></p>
<p>Again, we're essentially just creating a pretty URL for the client to leverage.</p>
<ul>
<li>The client requests http://cadlnx/mq/scalar</li>
<li>Nginx intercepts and massages the request</li>
<li>The server responds with the resource found at http://127.0.0.1:8080/scalar</li>
</ul>
<p>The regex is relatively straightforward as well</p>
<ul>
<li>^/mq/ : match only if we're at the beginning of the URI, so http://cadlnx/mq will match but http://cadlnx/foo/mq will not</li>
<li>(.*) : wildcard for capture group</li>
<li>$ : anchor to match end of string</li>
<li>/$1 : replacement to append parameters from capture group to '/'</li>
</ul>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nginx-3"><a class="header" href="#nginx-3">Nginx</a></h1>
<h2 id="logs"><a class="header" href="#logs">Logs</a></h2>
<h3 id="error-log"><a class="header" href="#error-log">Error Log:</a></h3>
<p><code>/var/log/nginx/error.log</code></p>
<h3 id="access-log"><a class="header" href="#access-log">Access Log:</a></h3>
<p><code>/var/log/nginx/access.log</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="logs-1"><a class="header" href="#logs-1">Logs</a></h1>
<h2 id="error-log-1"><a class="header" href="#error-log-1">Error Log:</a></h2>
<p><code>/var/log/nginx/error.log</code></p>
<h2 id="access-log-1"><a class="header" href="#access-log-1">Access Log:</a></h2>
<p><code>/var/log/nginx/access.log</code></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
