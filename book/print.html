<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>cad-containters</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>‚Üê</kbd> or <kbd>‚Üí</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">cad-containters</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="containerize-an-application"><a class="header" href="#containerize-an-application">Containerize an Application</a></h1>
<blockquote>
<p>‚ÑπÔ∏è <strong>Note</strong></p>
<p>Quick start example for containerizing a .NET application in Podman.</p>
<p>In this example, we'll deploy <code>CAD.MQ.API</code> in a container on <code>uit1446</code></p>
</blockquote>
<blockquote>
<p>‚õî <strong>Requirements</strong></p>
<p>üè∑Ô∏è <a href="quickstart/../podman/local_setup.html">Local Setup</a></p>
<p>üè∑Ô∏è <a href="quickstart/../podman/containerization/dockerfiles.html">Containerization: Dockerfiles</a></p>
</blockquote>
<h2 id="step-1-create-a-dockerfile"><a class="header" href="#step-1-create-a-dockerfile">Step 1: Create a Dockerfile</a></h2>
<pre><code class="language-dockerfile"># Set up .NET runtime env
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
WORKDIR /app
EXPOSE 8080

# Build Project
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
ARG BUILD_CONFIGURATION=Release
WORKDIR /src 
COPY ["/CAD.MQ.API/CAD.MQ.API.csproj", "CAD.MQ.API/"]
RUN dotnet restore "CAD.MQ.API/CAD.MQ.API.csproj"
COPY . .
WORKDIR "/src/CAD.MQ.API"
RUN dotnet build "./CAD.MQ.API.csproj" -c $BUILD_CONFIGURATION -o /app/build

FROM build AS publish
ARG BUILD_CONFIGURATION=Release
RUN dotnet publish "./CAD.MQ.API.csproj" -c $BUILD_CONFIGURATION -o /app/publish /p:UseAppHost=false

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .

ENTRYPOINT ["dotnet", "CAD.MQ.API.dll"]
</code></pre>
<h2 id="step-2-push-image-to-remote-server"><a class="header" href="#step-2-push-image-to-remote-server">Step 2: Push Image to Remote Server</a></h2>
<h3 id="1-open-terminal-and-cd-to-root-dir-eg-cad24x7"><a class="header" href="#1-open-terminal-and-cd-to-root-dir-eg-cad24x7">1. Open terminal and <strong><code>cd</code></strong> to root dir <strong><code>e.g. CAD24x7</code></strong></a></h3>
<h3 id="2-build-image"><a class="header" href="#2-build-image">2. Build Image</a></h3>
<pre><code class="language-bash">$ podman build -f CAD.MQ.API/Dockerfile -t cmqapi:latest .
</code></pre>
<blockquote>
<p>‚ÑπÔ∏è <strong>Note</strong></p>
<p><code>-f</code> path to dockerfile</p>
<p><code>-t</code> tag name</p>
</blockquote>
<h3 id="3-save-image-as-tar"><a class="header" href="#3-save-image-as-tar">3. Save image as <strong><code>.tar</code></strong></a></h3>
<pre><code class="language-bash">$ podman save -o cmqapi.tar localhost/cmqapi:latest`
</code></pre>
<blockquote>
<p>‚ÑπÔ∏è <strong>Note</strong></p>
<p><code>localhost</code> is automatically prepended in the previous step because we're not specifying a public registry or a namespace</p>
<p>This is Podmans way of indicating that this is a "<em>local image</em>", and has not been pulled or pushed to a remote repository</p>
</blockquote>
<h3 id="4-push-tar"><a class="header" href="#4-push-tar">4. Push <strong><code>.tar</code></strong></a></h3>
<pre><code class="language-bash">$ scp cmqapi.tar lev013@uit1446.govt.hcg.local:/home/lev013
</code></pre>
<blockquote>
<p>‚ÑπÔ∏è <strong>Note</strong></p>
<p>Pushing to <code>user@hostname:homedir</code></p>
</blockquote>
<h2 id="step-3-extract-image-on-remote-server"><a class="header" href="#step-3-extract-image-on-remote-server">Step 3: Extract image on Remote Server</a></h2>
<h3 id="1-open-terminal-and-cd-to-dir-containing-image-tar"><a class="header" href="#1-open-terminal-and-cd-to-dir-containing-image-tar">1. Open terminal and cd to dir containing image .tar</a></h3>
<h3 id="2-load-image-from-tar"><a class="header" href="#2-load-image-from-tar">2. Load image from <strong><code>.tar</code></strong></a></h3>
<pre><code class="language-bash">$ podman load -i cmqapi.tar
</code></pre>
<h2 id="step-4-start-app-in-container"><a class="header" href="#step-4-start-app-in-container">Step 4: Start App in Container</a></h2>
<h3 id="1-start-a-container"><a class="header" href="#1-start-a-container">1. Start a container</a></h3>
<pre><code class="language-bash">$ podman run -d -p 8080:8080 --name cmqapi localhost/cmqapi:latest
</code></pre>
<blockquote>
<p>‚ÑπÔ∏è <strong>Note</strong></p>
<p><code>-d</code> run detached</p>
<p><code>-p</code> forward port on host to port on container</p>
<p><code>--name</code> name of container</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="config"><a class="header" href="#config">Config</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dockerfiles"><a class="header" href="#dockerfiles">Dockerfiles</a></h1>
<pre><code class="language-dockerfile"># Set up .NET runtime env
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
WORKDIR /app
EXPOSE 8080

# Build Project
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
ARG BUILD_CONFIGURATION=Release
WORKDIR /src 
COPY ["/CAD.MQ.API/CAD.MQ.API.csproj", "CAD.MQ.API/"]
RUN dotnet restore "CAD.MQ.API/CAD.MQ.API.csproj"
COPY . .
WORKDIR "/src/CAD.MQ.API"
RUN dotnet build "./CAD.MQ.API.csproj" -c $BUILD_CONFIGURATION -o /app/build

FROM build AS publish
ARG BUILD_CONFIGURATION=Release
RUN dotnet publish "./CAD.MQ.API.csproj" -c $BUILD_CONFIGURATION -o /app/publish /p:UseAppHost=false

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .

ENTRYPOINT ["dotnet", "CAD.MQ.API.dll"]
</code></pre>
<p>Super High-Level explanation of a dockerfile</p>
<p>Dockerfiles are powerful because they leverage a concept called layered caching to efficiently build images of an application. Without caching, we would need to do things like reinstall dependencies and recompile the source code every single time we rebuild an image ü´£</p>
<pre><code>A dockerfile is essentially just a chain of sequential commands called layers. e.g. FROM, COPY, RUN, etc.
These layers are cached and evaluated sequentially.
A layer's cache is invalidated if
    the underlying command changes
    any files it depends on changes
    any prior layer has been invalidated, e.g. if we change the .NET runtime from aspnet:9.0 to aspnet:10.0, we would essentially need to rebuild the entire image
.dockerignore files can help with preventing unneseccary cache invalidation due to changes in dotfiles like .git or changes in bin/ and obj/
</code></pre>
<p>Example:</p>
<p>‚ùå Bad</p>
<p>COPY . .
RUN dotnet restore #runs even if we simply added a comment or removed whitespace</p>
<p>‚úîÔ∏è Good</p>
<p>COPY project.csproj .
RUN dotnet restore #only runs if the .csproj changes</p>
<p>COPY . .
RUN dotnet build #only runs if the source code changes</p>
<p>... there's some nuance here, but you get the idea</p>
<p>üìùCaching Dockerfiles</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="local-setup"><a class="header" href="#local-setup">Local Setup</a></h1>
<h2 id="install-podman-locally"><a class="header" href="#install-podman-locally">Install Podman Locally</a></h2>
<blockquote>
<p>‚ÑπÔ∏è <strong>Note</strong></p>
<p>Podman is installed on our RHEL servers by default, but it must also be installed locally to be able to build the images of our applications.</p>
</blockquote>
<p>üîó <a href="https://github.com/containers/podman/releases/download/v5.5.2/podman-5.5.2-setup.exe" target="_blank">Install Podman CLI</a></p>
<blockquote>
<p>I went with the CLI version since this workflow really only requires that we build the image locally</p>
</blockquote>
<p>On Windows, Podman runs inside of a WSL2 container, but you can still communicate with the service via cmd or powershell. The installer should handle the setup + config of WSL if it's not already enabled on your machine.</p>
<p><a href="https://github.com/containers/podman/blob/main/docs/tutorials/podman-for-windows.md">Podman for Windows</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cockpit"><a class="header" href="#cockpit">Cockpit</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="config-1"><a class="header" href="#config-1">Config</a></h1>
<h2 id="configure-firewalld-for-http"><a class="header" href="#configure-firewalld-for-http">Configure <strong><code>firewalld</code></strong> for http</a></h2>
<p>üîó <a href="https://www.redhat.com/en/blog/firewalld-linux-firewall">RHEL firewalld Docs</a></p>
<p>By default, <code>firewalld</code> does not allow http requests.</p>
<pre><code class="language-bash">sudo firewall-cmd --add-service=http --permanent`

sudo firewall-cmd --reload
</code></pre>
<h2 id="selinux"><a class="header" href="#selinux">SELinux</a></h2>
<p>üîó <a href="https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/8/html/using_selinux/index">RHEL SELinux Docs</a></p>
<p>SELinux is enabled by default on RHEL (<em>enforcing mode</em>) and comes with a lot of default security options that should not be carelessly disabled (<em>permissive mode</em>).</p>
<p>However, when SELinux enforcing mode is enabled, outbound network connections are restricted by default. This means that services like Nginx are not permitted to make outbound requests e.g. <code>proxy_pass</code></p>
<blockquote>
<p>connect() to 127.0.0.1:8080 failed (13: Permission denied)</p>
</blockquote>
<p>Instead of setting SELinux to permissive mode, we can simply allow services to make outbound connections using TCP:</p>
<pre><code class="language-bash">sudo setsebool -P httpd_can_network_connect on
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nginx"><a class="header" href="#nginx">Nginx</a></h1>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p>üîó <a href="https://nginx.org/en/docs/index.html" target="_blank">Nginx Documentation</a></p>
<pre><code class="language-bash">sudo dnf install nginx

sudo systemctl enable --now nginx
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nginx-1"><a class="header" href="#nginx-1">Nginx</a></h1>
<h2 id="what-is-a-reverse-proxy"><a class="header" href="#what-is-a-reverse-proxy">What is a reverse proxy?</a></h2>
<p>üîó <a href="https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/" target="_blank">Reverse Proxy</a></p>
<p>A reverse proxy acts as an intermediary between clients and servers. They intercept client requests and forward them to the appropriate backend service.</p>
<h2 id="why-a-reverse-proxy"><a class="header" href="#why-a-reverse-proxy">Why a reverse proxy?</a></h2>
<p>By default, our containerized applications will be accessible from the server's hostname on the port(s) that we choose to expose, e.g. <code>http://uit1446:8080/</code></p>
<p>... But this is admittedly pretty obnoxious for the client to use.</p>
<p>Assuming we've set up the required DNS on the local network, <em>(or modified our Hosts file for testing purposes)</em>, we can use Nginx to bind our apps to those addresses on the server and serve our content from an <strong>"alias"</strong>.</p>
<hr />
<p>A reverse proxy will allow us to specify a hostname and it's relative path(s) for the client to reach out to. Nginx can then intercept, and subsequently proxy incoming requests to the corresponding resource on the server.</p>
<p>Here is an example using CAD.MQ.API</p>
<ul>
<li>We have an application running on the server exposed on <code>:8080</code></li>
<li>Clients can natively make requests to the service on <code>http://uit1446:8080/</code></li>
<li>With a reverse proxy, we can set a custom hostname for our URI: <code>http://cadlnx/mq/</code></li>
</ul>
<h2 id="setup"><a class="header" href="#setup">Setup:</a></h2>
<blockquote>
<p>‚õî <strong>Requirements</strong></p>
<p>üè∑Ô∏è <a href="rhel/nginx/../nginx/installation.html">Nginx: Installation</a></p>
</blockquote>
<h3 id="1-set-up-custom-conf-inside-of-etcnginxconfd"><a class="header" href="#1-set-up-custom-conf-inside-of-etcnginxconfd">1. Set up custom conf inside of <code>/etc/nginx/conf.d/</code></a></h3>
<blockquote>
<p>‚ÑπÔ∏è Note</p>
<p>Instead of modifying <code>/etc/nginx/nginx.conf</code> directly, it's generally considered best practice to create a custom config file inside of <code>/conf.d</code></p>
<p>In this example, we're writing to <code>/etc/nginx/conf.d/cad.conf</code></p>
</blockquote>
<h3 id="2-add-the-reverse-proxy-config"><a class="header" href="#2-add-the-reverse-proxy-config">2. Add the reverse proxy config</a></h3>
<pre><code class="language-nginx">server { 
        listen 80; # what port Nginx should listen on
        server_name cadlnx; # what hostname the following location block(s) should respond to
         
        location /mq/ { # location block containing rules/logic for handling requests to http://cadlnx/mq/*
                rewrite ^/mq/(.*)$ /$1 break; 
                proxy_pass http://127.0.0.1:8080; # underlying address we're proxying traffic to 

                proxy_set_header Host $host; # retains original host value e.g. cadlnx
                proxy_set_header X-Real-IP $remote_addr; # client's real IP addr 
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # full chain of fwd IPs
                proxy_set_header X-Forwarded-Proto $scheme; # http or https 
        }

        location /foo/ { # e.g. some other location block for handling http://cadlnx/foo/
                ...
        }
} 
</code></pre>
<blockquote>
<p>‚ÑπÔ∏è Note</p>
<p><em>It's important to remember that the goal here is to simply proxy traffic.</em></p>
<pre><code class="language-nginx">rewrite ^/mq/(.*)$ /$1 break;
</code></pre>
<p>The idea behind this rewrite is that we need to strip <code>/mq/</code> from the URI and reappend any parameters from the capture group.</p>
<ol>
<li>The client requests <code>http://cadlnx/mq/scalar</code></li>
<li>Nginx intercepts and maps the request to the corresponding resource on the server</li>
<li>The server responds with the resource found at `http://127.0.0.1:8080/scalar</li>
</ol>
<p>Quick regex explanation</p>
<ul>
<li><code>^/mq/</code> - match only if we're at the beginning of the URI
<ul>
<li>‚úÖ <code>http://cadlnx/mq</code></li>
<li>‚ùå <code>http://cadlnx/foo/mq</code></li>
</ul>
</li>
<li><code>(.*)</code> - wildcard for capture group</li>
<li><code>$</code> - anchor to match end of string</li>
<li><code>/$1</code> - replacement to append parameters from capture group to '/'</li>
</ul>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nginx-2"><a class="header" href="#nginx-2">Nginx</a></h1>
<h2 id="error-log"><a class="header" href="#error-log">Error Log:</a></h2>
<pre><code class="language-bash">$ sudo less /var/log/nginx/error.log
</code></pre>
<h2 id="access-log"><a class="header" href="#access-log">Access Log:</a></h2>
<pre><code class="language-bash">$ sudo less /var/log/nginx/access.log
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sysadmin"><a class="header" href="#sysadmin">Sysadmin</a></h1>
<blockquote>
<p>When we spin up new servers, there are certain configurations that the sysadmins can set up by default.</p>
</blockquote>
<ol>
<li><a href="sysadmin/../rhel/config.html#configure-firewalld-for-http">Add HTTP to firewalld</a></li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
